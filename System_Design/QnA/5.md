# Medium-Difficulty System Design Q&A — Set 4

## 1) Design a CDN (Content Delivery Network) for static assets
**Question:** How would you design a CDN to serve images/CSS/JS globally with low latency?  
**Answer:**  
- **Components:** Anycast DNS, edge POPs (reverse proxies), origin storage (S3/GCS), control plane, cache invalidation service.  
- **Flow:** Client → DNS routes to nearest POP → POP serves from cache or fetches from origin → caches with TTL/ETag.  
- **Key Design Points:**  
  - Cache keys include path + query + headers (e.g., Accept-Encoding).  
  - Use **ETag/If-None-Match** and **Cache-Control** for revalidation.  
  - Image variants via edge workers (resize/format).  
- **Scaling/Resilience:** Multiregion origins, tiered caching (edge → regional → origin), pre-warm hot assets.  
- **Challenges:** Invalidation at scale, cache stampedes, TLS termination at edge.

---

## 2) Design an API Gateway for microservices
**Question:** How would you build an API gateway that handles auth, routing, and rate-limits?  
**Answer:**  
- **Components:** Gateway layer (NGINX/Envoy), AuthN/AuthZ service (OIDC/JWT), rate limiter (Redis), service registry (Consul), observability.  
- **Flow:** Client → Gateway (JWT validate, rate check) → route via service registry → backend service → response.  
- **Features:** Request/response transforms, canary routing, circuit breakers, retries, global headers, idempotency keys.  
- **Scaling:** Horizontal gateway replicas behind L4 LB; co-locate Redis clusters per region.  
- **Challenges:** Multi-tenant throttling accuracy, auth cache staleness, safe timeouts to avoid retry storms.

---

## 3) Design a Feature Flag (Config) service
**Question:** How would you design a system to toggle features per user/segment in real time?  
**Answer:**  
- **Model:** `flag { name, default, rules[segment matchers], rollout % }`.  
- **Architecture:** Control plane (CRUD UI + audit), config store (strongly consistent DB), edge config cache (long-poll/SSE), SDKs with local cache.  
- **Flow:** Client SDK fetches snapshot, evaluates locally; server can push deltas (SSE) for sub-1s propagation.  
- **Safety:** Prerequisite flags, kill switches, targeting by attributes with privacy filters.  
- **Challenges:** Evaluation correctness across SDKs, config drift, blast-radius control.

---

## 4) Design a Real-time Analytics Dashboard (sub-second)
**Question:** How to design a dashboard that shows near real-time metrics (≤ 2s lag)?  
**Answer:**  
- **Pipeline:** Ingest (gRPC/HTTP) → Kafka → Stream processor (Flink) → Aggregates to OLAP (ClickHouse/Druid) → API → Websocket to UI.  
- **Data:** Append-only events with tenant, metric, ts; rollups at 1s/10s windows.  
- **Optimizations:** Pre-aggregate hot metrics, columnar storage, time-partitioned tables, dictionary-encoded dimensions.  
- **Challenges:** Late events/watermarks, exactly-once semantics, multi-tenant isolation.

---

## 5) Design a Content Moderation Pipeline (text & images)
**Question:** How to moderate UGC for spam/toxicity/NFSW at scale?  
**Answer:**  
- **Stages:** Ingest → Synchronous light checks (regex/URL denylist) → Async ML scoring (NLP/CV) → Human review queue → Actions (block, shadow-ban).  
- **Storage:** Raw content in object store; metadata + labels + decisions in SQL; audit logs immutable.  
- **Throughput:** Use Kafka with priority topics; autoscale GPU workers for image/vision.  
- **Challenges:** Latency vs. accuracy trade-offs, model drift, appeal workflows, regional policy differences.

---

## 6) Design a Personalized Recommendation Service
**Question:** How to deliver “Top N for you” with freshness + scale?  
**Answer:**  
- **Offline:** Train embeddings (ALS/2-tower), compute candidate sets nightly, store in key–value (`user_id → candidates`).  
- **Online:** Real-time rerank with features (context, recency, popularity) via a low-latency model server.  
- **Infra:** Feature store (online/offline), ANN index (FAISS/ScaNN) for vector search, Redis cache for session features.  
- **Challenges:** Cold start, feedback loops, dedup/diversity, SLA (<50ms p95).

---

## 7) Design an IoT Telemetry Ingestion System
**Question:** How to ingest telemetry from 10M devices reliably?  
**Answer:**  
- **Protocols:** MQTT/HTTP with mutual TLS; device registry and cert rotation.  
- **Pipeline:** Edge brokers → regional brokers → Kafka → stream compaction → time-series DB (TimescaleDB/Cassandra) + warm S3.  
- **Controls:** Backpressure, rate caps per device, dead-letter topics, OTA updates channel separated from telemetry.  
- **Challenges:** Out-of-order data, clock skew, intermittent connectivity.

---

## 8) Design a Geospatial Search (“stores near me”)
**Question:** How to return nearest stores with filters in <100ms?  
**Answer:**  
- **Indexing:** GeoHash/QuadTree; or Elasticsearch with `geo_point` and `geo_distance` queries.  
- **Flow:** Query(lat,lon,radius,filters) → geo filter → rank by distance + inventory/score → paginate.  
- **Data:** Store location, hours, inventory snapshot; maintain per-region shards.  
- **Challenges:** Accurate distance at scale, hotspot cities, frequent inventory updates.

---

## 9) Design an ETL/ELT Platform (Data Lake + Warehouse)
**Question:** How to build a reliable data platform for batch pipelines?  
**Answer:**  
- **Landing:** Raw data to object storage (S3/GCS) in open formats (Parquet/Delta).  
- **Orchestration:** Airflow/Dagster with retries, SLAs, backfills.  
- **Transform:** Spark/DBT; maintain data contracts and schema registry.  
- **Serve:** Warehouse (BigQuery/Snowflake/Redshift) + semantic layer; row/column security.  
- **Challenges:** Late-arriving data, idempotent loads, cost governance, data quality tests.

---

## 10) Design a Secrets Management Service (like Vault)
**Question:** How to manage app secrets, rotations, and access policies?  
**Answer:**  
- **Core:** KMS-backed master key, encrypted storage, RBAC policies, audit logs.  
- **Features:** Dynamic secrets (short-lived DB creds), auto-rotation, lease & revoke, transit encryption (envelope).  
- **Access:** Auth via OIDC/JWT, Kubernetes ServiceAccounts, MFA for humans; sidecar agents to fetch/refresh.  
- **Challenges:** HA with strong consistency, zero secret exposure in logs, blast-radius during rotations.
